"use strict";(self.webpackChunkdomino_docs=self.webpackChunkdomino_docs||[]).push([[772],{5680:(e,o,n)=>{n.d(o,{xA:()=>c,yg:()=>g});var t=n(6540);function i(e,o,n){return o in e?Object.defineProperty(e,o,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[o]=n,e}function a(e,o){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var t=Object.getOwnPropertySymbols(e);o&&(t=t.filter((function(o){return Object.getOwnPropertyDescriptor(e,o).enumerable}))),n.push.apply(n,t)}return n}function l(e){for(var o=1;o<arguments.length;o++){var n=null!=arguments[o]?arguments[o]:{};o%2?a(Object(n),!0).forEach((function(o){i(e,o,n[o])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):a(Object(n)).forEach((function(o){Object.defineProperty(e,o,Object.getOwnPropertyDescriptor(n,o))}))}return e}function r(e,o){if(null==e)return{};var n,t,i=function(e,o){if(null==e)return{};var n,t,i={},a=Object.keys(e);for(t=0;t<a.length;t++)n=a[t],o.indexOf(n)>=0||(i[n]=e[n]);return i}(e,o);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);for(t=0;t<a.length;t++)n=a[t],o.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(i[n]=e[n])}return i}var p=t.createContext({}),d=function(e){var o=t.useContext(p),n=o;return e&&(n="function"==typeof e?e(o):l(l({},o),e)),n},c=function(e){var o=d(e.components);return t.createElement(p.Provider,{value:o},e.children)},s="mdxType",u={inlineCode:"code",wrapper:function(e){var o=e.children;return t.createElement(t.Fragment,{},o)}},m=t.forwardRef((function(e,o){var n=e.components,i=e.mdxType,a=e.originalType,p=e.parentName,c=r(e,["components","mdxType","originalType","parentName"]),s=d(n),m=i,g=s["".concat(p,".").concat(m)]||s[m]||u[m]||a;return n?t.createElement(g,l(l({ref:o},c),{},{components:n})):t.createElement(g,l({ref:o},c))}));function g(e,o){var n=arguments,i=o&&o.mdxType;if("string"==typeof e||i){var a=n.length,l=new Array(a);l[0]=m;var r={};for(var p in o)hasOwnProperty.call(o,p)&&(r[p]=o[p]);r.originalType=e,r[s]="string"==typeof e?e:i,l[1]=r;for(var d=2;d<a;d++)l[d]=n[d];return t.createElement.apply(null,l)}return t.createElement.apply(null,n)}m.displayName="MDXCreateElement"},840:(e,o,n)=>{n.r(o),n.d(o,{assets:()=>p,contentTitle:()=>l,default:()=>u,frontMatter:()=>a,metadata:()=>r,toc:()=>d});var t=n(8168),i=(n(6540),n(5680));const a={},l="Domino-py",r={unversionedId:"development/domino-py",id:"development/domino-py",title:"Domino-py",description:"Domino package can not be tested in docker compose with hot reload.",source:"@site/docs/development/domino-py.md",sourceDirName:"development",slug:"/development/domino-py",permalink:"/development/domino-py",draft:!1,tags:[],version:"current",frontMatter:{},sidebar:"tutorialSidebar",previous:{title:"Domino REST",permalink:"/development/rest"}},p={},d=[{value:"Kubernetes",id:"kubernetes",level:2},{value:"1. Activating hot reloading for local domino package",id:"1-activating-hot-reloading-for-local-domino-package",level:3},{value:"2. Using local helm charts when creating the cluster",id:"2-using-local-helm-charts-when-creating-the-cluster",level:3},{value:"3. Using local frontend image in cluster",id:"3-using-local-frontend-image-in-cluster",level:3},{value:"4. Using local rest image in cluster",id:"4-using-local-rest-image-in-cluster",level:3},{value:"5. Using local airflow base image",id:"5-using-local-airflow-base-image",level:3},{value:"5. Activating hot reloading for local pieces repositories code",id:"5-activating-hot-reloading-for-local-pieces-repositories-code",level:3},{value:"Docker Compose",id:"docker-compose",level:2}],c={toc:d},s="wrapper";function u(e){let{components:o,...n}=e;return(0,i.yg)(s,(0,t.A)({},c,n,{components:o,mdxType:"MDXLayout"}),(0,i.yg)("h1",{id:"domino-py"},"Domino-py"),(0,i.yg)("admonition",{type:"warning"},(0,i.yg)("p",{parentName:"admonition"},"Domino package can ",(0,i.yg)("strong",{parentName:"p"},"not")," be tested in docker compose with hot reload.")),(0,i.yg)("h2",{id:"kubernetes"},"Kubernetes"),(0,i.yg)("p",null,"When running the application in development mode using the key ",(0,i.yg)("inlineCode",{parentName:"p"},"DOMINO_DEPLOY_MODE=local-k8s-dev")," in your ",(0,i.yg)("inlineCode",{parentName:"p"},"config.toml")," file, the application will use the Kubernetes API to create some volumes mappings, allowing some development features:"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Hot reloading for local domino package."),(0,i.yg)("li",{parentName:"ol"},"Use of local helm charts when creating the cluster."),(0,i.yg)("li",{parentName:"ol"},"Use of local frontend image in cluster."),(0,i.yg)("li",{parentName:"ol"},"Use of local rest image in cluster."),(0,i.yg)("li",{parentName:"ol"},"Hot reloading for local pieces repositories code.")),(0,i.yg)("h3",{id:"1-activating-hot-reloading-for-local-domino-package"},"1. Activating hot reloading for local domino package"),(0,i.yg)("p",null,"If you want to run your cluster with hot reloading for your local domino package you should follow the next steps:"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Go to your ",(0,i.yg)("inlineCode",{parentName:"li"},"config.toml")," file in the ",(0,i.yg)("inlineCode",{parentName:"li"},"dev")," section"),(0,i.yg)("li",{parentName:"ol"},"Add the key ",(0,i.yg)("inlineCode",{parentName:"li"},"DOMINO_LOCAL_DOMINO_PACKAGE")," with the value to the path of your ",(0,i.yg)("inlineCode",{parentName:"li"},"src/domino")," folder of your local domino package. Example: ",(0,i.yg)("inlineCode",{parentName:"li"},"DOMINO_LOCAL_DOMINO_PACKAGE=path/to/your/domino/src/domino"))),(0,i.yg)("h3",{id:"2-using-local-helm-charts-when-creating-the-cluster"},"2. Using local helm charts when creating the cluster"),(0,i.yg)("p",null,"If you need to test run your cluster with local helm charts you should follow the same steps as the previous section.\nThe applicaton will get the ",(0,i.yg)("inlineCode",{parentName:"p"},"helm")," folder from the path ",(0,i.yg)("inlineCode",{parentName:"p"},"path/to/your/domino/helm/domino")," based on the path you defined in the ",(0,i.yg)("inlineCode",{parentName:"p"},"DOMINO_LOCAL_DOMINO_PACKAGE")," key.\nSo, edit your helm charts in the ",(0,i.yg)("inlineCode",{parentName:"p"},"path/to/your/domino/helm/domino")," folder and the application will use them when creating the cluster."),(0,i.yg)("h3",{id:"3-using-local-frontend-image-in-cluster"},"3. Using local frontend image in cluster"),(0,i.yg)("p",null,"If you want to run your cluster with a local frontend image you should follow the next steps:"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Build your local frontend image. You can use the following command from the root of the project: ",(0,i.yg)("inlineCode",{parentName:"li"},"DOCKER_BUILDKIT=1 docker build -f ./frontend/Dockerfile.dev -t domino-frontend ./frontend")),(0,i.yg)("li",{parentName:"ol"},"Add the key ",(0,i.yg)("inlineCode",{parentName:"li"},"DOMINO_FRONTEND_IMAGE")," with the value ",(0,i.yg)("inlineCode",{parentName:"li"},"domino-frontend")," (or other tag you choose) to your ",(0,i.yg)("inlineCode",{parentName:"li"},"config.toml")," file in the ",(0,i.yg)("inlineCode",{parentName:"li"},"dev")," section.\n",(0,i.yg)("strong",{parentName:"li"},"Important:")," This will not activate hot reloading for your local frontend code. If you need to update your frontend code in the cluster you should build the image again.")),(0,i.yg)("h3",{id:"4-using-local-rest-image-in-cluster"},"4. Using local rest image in cluster"),(0,i.yg)("p",null,"As the frontend image, if you want to run your cluster with a local rest image you should follow the next steps:"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Build your local rest image. You can use the following command from the root of the project: ",(0,i.yg)("inlineCode",{parentName:"li"},"DOCKER_BUILDKIT=1 docker build -f ./rest/Dockerfile -t domino-rest ./rest")),(0,i.yg)("li",{parentName:"ol"},"Add the key ",(0,i.yg)("inlineCode",{parentName:"li"},"DOMINO_REST_IMAGE")," with the value ",(0,i.yg)("inlineCode",{parentName:"li"},"domino-rest")," (or other tag you choose) to your ",(0,i.yg)("inlineCode",{parentName:"li"},"config.toml")," file in the ",(0,i.yg)("inlineCode",{parentName:"li"},"dev")," section.")),(0,i.yg)("p",null,"This will load your local rest image in the kind cluster.\n",(0,i.yg)("strong",{parentName:"p"},"Important:")," This will not activate hot reloading for your local rest code. If you need to update your rest code in the cluster you should build the image again."),(0,i.yg)("h3",{id:"5-using-local-airflow-base-image"},"5. Using local airflow base image"),(0,i.yg)("p",null,"If you need to update the base airflow image used in worker and scheduler containers you can do it by following the next steps:"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Build your local airflow base image. You can use the following command from the root of the project: ",(0,i.yg)("inlineCode",{parentName:"li"},"DOCKER_BUILDKIT=1 docker build -f Dockerfile-airflow-domino.dev -t domino-airflow .")),(0,i.yg)("li",{parentName:"ol"},"Addthe key ",(0,i.yg)("inlineCode",{parentName:"li"},"DOMINO_AIRFLOW_IMAGE")," with the value ",(0,i.yg)("inlineCode",{parentName:"li"},"domino-airflow")," (or other tag you choose) to your ",(0,i.yg)("inlineCode",{parentName:"li"},"config.toml")," file in the ",(0,i.yg)("inlineCode",{parentName:"li"},"dev")," section.")),(0,i.yg)("p",null,"This will load your local airflow base image in the kind cluster.\n",(0,i.yg)("strong",{parentName:"p"},"Important:")," This is useful if you want to update airflow image dependencies.\nTo update only the domino package code in the airflow containers you don't need to build the image again, you can use the hot reloading feature for local domino package describe in the section 1."),(0,i.yg)("h3",{id:"5-activating-hot-reloading-for-local-pieces-repositories-code"},"5. Activating hot reloading for local pieces repositories code"),(0,i.yg)("p",null,"You can activate hot reloading for the local code of your pieces repositories. To do so, you should follow the next steps:"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Go to your ",(0,i.yg)("inlineCode",{parentName:"li"},"config.toml")," file in the ",(0,i.yg)("inlineCode",{parentName:"li"},"dev")," section"),(0,i.yg)("li",{parentName:"ol"},"Add the key ",(0,i.yg)("inlineCode",{parentName:"li"},"<piece_repository_name>")," with the value to the path of your ",(0,i.yg)("inlineCode",{parentName:"li"},"<piece_repository_name>")," folder of your local pieces repository. Example: ",(0,i.yg)("inlineCode",{parentName:"li"},"default_domino_pieces=path/to/your/default_domino_pieces"),"\nThe ",(0,i.yg)("inlineCode",{parentName:"li"},"<piece_repository_name>")," must be the same name in the piece repository ",(0,i.yg)("inlineCode",{parentName:"li"},"config.toml")," file in ",(0,i.yg)("inlineCode",{parentName:"li"},"REPOSITORY_NAME")," key.")),(0,i.yg)("p",null,"The application will create a volume mapping between the path you specified and the path in the cluster where the pieces repository is mounted. This will allow you to update your pieces repository code and see the changes in the cluster without the need to build the image again."),(0,i.yg)("h2",{id:"docker-compose"},"Docker Compose"),(0,i.yg)("p",null,"You can run your application in development mode using docker compose file.\nTo do so, you should run using the ",(0,i.yg)("inlineCode",{parentName:"p"},"docker-compose-dev.yaml")," file, as follows:"),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-bash"},"docker-compose -f docker-compose-dev.yaml up\n")),(0,i.yg)("p",null,"This will activate some development features, such as:"),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Hot reloading for local domino package in ",(0,i.yg)("inlineCode",{parentName:"li"},"worker")," and ",(0,i.yg)("inlineCode",{parentName:"li"},"scheduler")," containers."),(0,i.yg)("li",{parentName:"ol"},"Hot reloading for ",(0,i.yg)("inlineCode",{parentName:"li"},"rest")," code."),(0,i.yg)("li",{parentName:"ol"},"Hot reloading for ",(0,i.yg)("inlineCode",{parentName:"li"},"frontend")," code.")),(0,i.yg)("admonition",{type:"warning"},(0,i.yg)("p",{parentName:"admonition"},(0,i.yg)("strong",{parentName:"p"},"Important:")," This will ",(0,i.yg)("strong",{parentName:"p"},"not")," activate hot reloading for your pieces repositories code and will ",(0,i.yg)("strong",{parentName:"p"},"not")," activate hot reloading for local domino package in the ",(0,i.yg)("strong",{parentName:"p"},"pieces containers"),". If you are running a piece and you need to have the domino package updated in the piece container you should update the piece image wit the domino development package you want to use.")),(0,i.yg)("admonition",{type:"note"},(0,i.yg)("p",{parentName:"admonition"},(0,i.yg)("strong",{parentName:"p"},"Workaround:")," As mentioned before, currently we don't have a direct way to allow hot reloading for domino package in pieces containers, however, you can use the following workaround:")),(0,i.yg)("ol",null,(0,i.yg)("li",{parentName:"ol"},"Go to ",(0,i.yg)("inlineCode",{parentName:"li"},"src/domino/custom_operators/docker_operator.py")," file."),(0,i.yg)("li",{parentName:"ol"},"find the following code:")),(0,i.yg)("pre",null,(0,i.yg)("code",{parentName:"pre",className:"language-python"},"dev_pieces = False\nif dev_pieces:\n    piece_repo_name = repository_url.split(\"/\")[-1]\n    local_repos_path = f\"/path/to/your/pieces/location/{piece_repo_name}\"\n    mounts = [\n        Mount(source='/path/to/your/domino/location/src/domino', target='/usr/local/lib/python3.10/site-packages/domino/', type='bind', read_only=True),\n        Mount(source=local_repos_path, target='/home/domino/pieces_repository/', type='bind', read_only=True),\n    ]\n\n")),(0,i.yg)("ol",{start:3},(0,i.yg)("li",{parentName:"ol"},"Change the ",(0,i.yg)("inlineCode",{parentName:"li"},"dev_pieces")," parameter to ",(0,i.yg)("inlineCode",{parentName:"li"},"True")," and populate the ",(0,i.yg)("inlineCode",{parentName:"li"},"source")," in each ",(0,i.yg)("inlineCode",{parentName:"li"},"mount")," path with a folder pointing to: domino source code and a folder containing all source codes for the pieces used by your workflows .")),(0,i.yg)("admonition",{type:"note"},(0,i.yg)("p",{parentName:"admonition"},"The workflow will attempt to use your mounted pieces folder, so all pieces must be present in the mounted folder. If not, the workflow will fail in execution.")))}u.isMDXComponent=!0}}]);
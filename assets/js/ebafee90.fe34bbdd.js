"use strict";(self.webpackChunkdomino_docs=self.webpackChunkdomino_docs||[]).push([[6670],{5680:(e,t,n)=>{n.d(t,{xA:()=>c,yg:()=>d});var i=n(6540);function o(e,t,n){return t in e?Object.defineProperty(e,t,{value:n,enumerable:!0,configurable:!0,writable:!0}):e[t]=n,e}function r(e,t){var n=Object.keys(e);if(Object.getOwnPropertySymbols){var i=Object.getOwnPropertySymbols(e);t&&(i=i.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),n.push.apply(n,i)}return n}function s(e){for(var t=1;t<arguments.length;t++){var n=null!=arguments[t]?arguments[t]:{};t%2?r(Object(n),!0).forEach((function(t){o(e,t,n[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(n)):r(Object(n)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(n,t))}))}return e}function a(e,t){if(null==e)return{};var n,i,o=function(e,t){if(null==e)return{};var n,i,o={},r=Object.keys(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||(o[n]=e[n]);return o}(e,t);if(Object.getOwnPropertySymbols){var r=Object.getOwnPropertySymbols(e);for(i=0;i<r.length;i++)n=r[i],t.indexOf(n)>=0||Object.prototype.propertyIsEnumerable.call(e,n)&&(o[n]=e[n])}return o}var l=i.createContext({}),p=function(e){var t=i.useContext(l),n=t;return e&&(n="function"==typeof e?e(t):s(s({},t),e)),n},c=function(e){var t=p(e.components);return i.createElement(l.Provider,{value:t},e.children)},u="mdxType",m={inlineCode:"code",wrapper:function(e){var t=e.children;return i.createElement(i.Fragment,{},t)}},y=i.forwardRef((function(e,t){var n=e.components,o=e.mdxType,r=e.originalType,l=e.parentName,c=a(e,["components","mdxType","originalType","parentName"]),u=p(n),y=o,d=u["".concat(l,".").concat(y)]||u[y]||m[y]||r;return n?i.createElement(d,s(s({ref:t},c),{},{components:n})):i.createElement(d,s({ref:t},c))}));function d(e,t){var n=arguments,o=t&&t.mdxType;if("string"==typeof e||o){var r=n.length,s=new Array(r);s[0]=y;var a={};for(var l in t)hasOwnProperty.call(t,l)&&(a[l]=t[l]);a.originalType=e,a[u]="string"==typeof e?e:o,s[1]=a;for(var p=2;p<r;p++)s[p]=n[p];return i.createElement.apply(null,s)}return i.createElement.apply(null,n)}y.displayName="MDXCreateElement"},9803:(e,t,n)=>{n.r(t),n.d(t,{assets:()=>l,contentTitle:()=>s,default:()=>m,frontMatter:()=>r,metadata:()=>a,toc:()=>p});var i=n(8168),o=(n(6540),n(5680));const r={sidebar_position:4},s="Pieces unit testing",a={unversionedId:"pieces/pieces_unit_testing",id:"pieces/pieces_unit_testing",title:"Pieces unit testing",description:"Domino provides a convenient function to test Pieces, the piecedryrun function.",source:"@site/docs/pieces/pieces_unit_testing.mdx",sourceDirName:"pieces",slug:"/pieces/pieces_unit_testing",permalink:"/pieces/pieces_unit_testing",draft:!1,tags:[],version:"current",sidebarPosition:4,frontMatter:{sidebar_position:4},sidebar:"tutorialSidebar",previous:{title:"Create Pieces",permalink:"/pieces/create_pieces"},next:{title:"Domino Components",permalink:"/category/domino-components"}},l={},p=[{value:"Unit tests on Github Actions",id:"unit-tests-on-github-actions",level:3},{value:"How tests work in Github Actions",id:"how-tests-work-in-github-actions",level:3},{value:"Choosing environment to run tests",id:"choosing-environment-to-run-tests",level:3}],c={toc:p},u="wrapper";function m(e){let{components:t,...n}=e;return(0,o.yg)(u,(0,i.A)({},c,n,{components:t,mdxType:"MDXLayout"}),(0,o.yg)("h1",{id:"pieces-unit-testing"},"Pieces unit testing"),(0,o.yg)("p",null,"Domino provides a convenient function to test Pieces, the ",(0,o.yg)("inlineCode",{parentName:"p"},"piece_dry_run")," function."),(0,o.yg)("p",null,"Suppose you created a Pieces repository and want to test the Pieces locally. It's possible to run tests without the whole Domino platform or a new repository release on GitHub."),(0,o.yg)("p",null,"Pre-requisites:"),(0,o.yg)("ul",null,(0,o.yg)("li",{parentName:"ul"},(0,o.yg)("inlineCode",{parentName:"li"},"domino-py")," installed in your local environment."),(0,o.yg)("li",{parentName:"ul"},"A local Pieces repository folder, following the standard organization (see ",(0,o.yg)("a",{parentName:"li",href:"./create_pieces"},"Create Pieces"),").")),(0,o.yg)("p",null,"You simply need to create a script importing the ",(0,o.yg)("inlineCode",{parentName:"p"},"piece_dry_run")," function and fill the arguments with the Piece inputs and secrets:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-python",metastring:'title="test_examplepiece.py"',title:'"test_examplepiece.py"'},'from domino.testing.dry_run import piece_dry_run\nimport os\n\npiece_dry_run(\n    repository_folder_path="path/to/pieces_repository",\n    piece_name="ExamplePiece",\n    input_data={\n        "in_argument_1": value,\n        "in_argument_2": value,\n        "in_argument_3": value\n    }\n    secrets_data={\n        "EXAMPLE_SECRET_1": os.environ.get("EXAMPLE_SECRET_1"),\n        "EXAMPLE_SECRET_2": os.environ.get("EXAMPLE_SECRET_2")\n    }\n)\n')),(0,o.yg)("p",null,"The ",(0,o.yg)("inlineCode",{parentName:"p"},"repository_folder_path")," should be the path to the root of the piece repository. Default value is ",(0,o.yg)("inlineCode",{parentName:"p"},"'.'"),"."),(0,o.yg)("p",null,"The ",(0,o.yg)("inlineCode",{parentName:"p"},"piece_name")," must be the same defined at the Piece's Folder."),(0,o.yg)("p",null,"The ",(0,o.yg)("inlineCode",{parentName:"p"},"input_data")," is a dict with the key-value arguments as defined in the Piece's InputModel."),(0,o.yg)("p",null,"The ",(0,o.yg)("inlineCode",{parentName:"p"},"secrets_data")," is a dict with the key-value arguments as defined in the Piece's SecretsModel."),(0,o.yg)("h3",{id:"unit-tests-on-github-actions"},"Unit tests on Github Actions"),(0,o.yg)("p",null,"Our ",(0,o.yg)("a",{parentName:"p",href:"https://github.com/Tauffer-Consulting/domino_pieces_repository_template"},"Template for Pieces repository")," provides out-of-the box Github actions that will automatically run the unit tests for all Pieces.\nThe unit tests should run successfully before the action publish the Pieces images."),(0,o.yg)("p",null,(0,o.yg)("inlineCode",{parentName:"p"},"pytest")," will recognize all files named ",(0,o.yg)("inlineCode",{parentName:"p"},"test_*.py")," in the Pieces folders and run them as tests."),(0,o.yg)("p",null,"For Pieces that require secrets, the best practice is to store the secrets in the repository settings: ",(0,o.yg)("inlineCode",{parentName:"p"},"Setings > Secrets and variables > Actions > Repository secrets"),". Then you should explicitly import the secrets as environment variables inside ",(0,o.yg)("inlineCode",{parentName:"p"},"/.github/workflows/validate-and-organize.yml"),". Example:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-yaml",metastring:'title="validate-and-organize.yml"',title:'"validate-and-organize.yml"'},"- name: Run tests over built images\n  env:\n    EXAMPLE_SECRET_1: ${{ secrets.EXAMPLE_SECRET_1 }}\n    EXAMPLE_SECRET_2: ${{ secrets.EXAMPLE_SECRET_2 }}\n  run: |\n    pytest\n")),(0,o.yg)("h3",{id:"how-tests-work-in-github-actions"},"How tests work in Github Actions"),(0,o.yg)("p",null,"In order to keep each piece environment isolated, the tests will run in the Github Actions environment but the piece function will be executed in a separated container.\nThe way we do this is basically in 3 steps:"),(0,o.yg)("ol",null,(0,o.yg)("li",{parentName:"ol"},"Build all the images and save a map for each piece name and corresponding image."),(0,o.yg)("li",{parentName:"ol"},"Based on the piece name defined on the test we run the built docker image starting a really tiny HTTP server in the piece container.\nThis HTTP server will listen the request from the piece_dry_run function, pass it to the piece_function and return the results to the test function."),(0,o.yg)("li",{parentName:"ol"},"The test function will receive the results from the piece_function and assert the expected results.")),(0,o.yg)("p",null,"The diagram below shows the architecture of the tests in Github Actions:"),(0,o.yg)("div",{style:{display:"flex",justifyContent:"center",marginBottom:"25px"}},(0,o.yg)("img",{style:{maxWidth:"600px"},src:"/img/pieces/tests/diagram-tests-architecture.jpg",alt:"Diagram of tests architecture",width:"100%"})),(0,o.yg)("p",null,"Also, this diagram ilustrates the flow of the tests in Github Actions:"),(0,o.yg)("div",{style:{display:"flex",justifyContent:"center"}},(0,o.yg)("img",{style:{maxWidth:"600px"},src:"/img/pieces/tests/diagram-test-flow.jpg",alt:"Diagram of tests flow",width:"100%"})),(0,o.yg)("br",null),(0,o.yg)("admonition",{type:"danger"},(0,o.yg)("p",{parentName:"admonition"},"The limitations of this approach are:"),(0,o.yg)("ol",{parentName:"admonition"},(0,o.yg)("li",{parentName:"ol"},"Tests will run slower than running them locally."),(0,o.yg)("li",{parentName:"ol"},"We can't mock internal functions"),(0,o.yg)("li",{parentName:"ol"},"We can't read files from outside of piece build. The only way to test pieces that use file by now is to add the test file to the piece build and on the test we can use the relative path to it or even the absolute path in the container, like ",(0,o.yg)("inlineCode",{parentName:"li"},"/home/domino/pieces_repository/pieces/MyPieceName/file_to_test.txt")))),(0,o.yg)("h3",{id:"choosing-environment-to-run-tests"},"Choosing environment to run tests"),(0,o.yg)("p",null,"Due to the above limitations, in certain cases, you may wish to exclusively run tests locally and skip them in Github Actions. To achieve this, you can utilize the @skip_envs decorator from the domino.testing module.\nExample:"),(0,o.yg)("pre",null,(0,o.yg)("code",{parentName:"pre",className:"language-python"},"from domino.testing.utils import skip_envs\n\n@skip_envs('github')\ndef test_my_piece():\n    # your test code here\n    ...\n\n")))}m.isMDXComponent=!0}}]);